cgra-opt \
--extract-affine-for-to-kernel \
0_three_mm_32.mlir > 1_mm_kernel.mlir


cgra-opt \
--extract-kernel-to-function=\
kernel-gen-dir=/home/tianyi/MLIRCGRA/CGRA-Flow/mlir-cgra/experiments/LJHtest/three_mm_32 \
1_mm_kernel.mlir


cgra-opt --adjust-kernel-mem-footprint=cachesize=1 1_mm_kernel.mlir 

cgra-opt --affine-loop-tile="cache-size=1" 0_three_mm_32.mlir

cgra-opt --affine-loop-unroll="unroll-factor=2" 0_three_mm_32.mlir

cgra-opt --affine-loop-normalize -affine-scalrep 2_gemm_outlined.mlir

cgra-opt --affine-loop-normalize -affine-scalrep \
    --mlir-print-ir-after-all 2_gemm_outlined.mlir \
    -o 3_gemm_normalized.mlir \
    2>&1 | cat > ./3_gemm_intermediate.mlir


# for kernels
cgra-opt --affine-loop-tile="cache-size=1 singlearraysize=1"   0_gemm_change.mlir 

## Note: -reconcile-unrealized-casts is needed
cgra-opt --arith-expand --memref-expand\
        -lower-affine --scf-for-loop-canonicalization  -convert-scf-to-cf\
        -convert-memref-to-llvm  --convert-math-to-llvm --convert-math-to-libm\
        --convert-arith-to-llvm\
        --affine-simplify-structures\
        -convert-func-to-llvm=use-bare-ptr-memref-call-conv\
        -reconcile-unrealized-casts \
        gemm_kernel_0.mlir -o 1_llvm_gemm_kernel_0.mlir\
        -mlir-print-ir-after-all 2>&1 | cat > 1_intermediate_gemm_kernel_0.mlir

mlir-translate --mlir-to-llvmir 1_llvm_gemm_kernel_0.mlir > gemm_kernel_0.ll